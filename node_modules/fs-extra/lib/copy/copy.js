'use strict'

const fs = require('graceful-fs')
const path = require('path')
const ncp = require('./ncp')
const mkdir = require('../mkdirs')
const pathExists = require('../path-exists').pathExists

//被导出去的方法
function copy (src, dest, options, callback) {
  //	如果没有options，只有callback
  if (typeof options === 'function' && !callback) {
    callback = options
    options = {}
  } else if (typeof options === 'function' || options instanceof RegExp) {
    options = {filter: options}
  }
  callback = callback || function () {}
  options = options || {}

  // Warn about using preserveTimestamps on 32-bit node:
  if (options.preserveTimestamps && process.arch === 'ia32') {
    console.warn(`fs-extra: Using the preserveTimestamps option in 32-bit node is not recommended;\n
    see https://github.com/jprichardson/node-fs-extra/issues/269`)
  }

  // don't allow src and dest to be the same
	//process.cwd()返回node当前工作目录
  const basePath = process.cwd()
	//path.resolve()  相当于cd 命令, path.resolve(process.cwd(), src)解决了绝对路径和相对路径的问题
  const currentPath = path.resolve(basePath, src)
  const targetPath = path.resolve(basePath, dest)
	console.log(currentPath, targetPath,'currentPath, targetPath')
  if (currentPath === targetPath) return callback(new Error('Source and destination must not be the same.'))

	//传入一个path, 返回 stats对象
  fs.lstat(src, (err, stats) => {
    if (err) return callback(err)

    let dir = null
	 // 如果path是一个路径
    if (stats.isDirectory()) {
    	//path.sep 是路径片段分隔符
      const parts = dest.split(path.sep)
      parts.pop()
      dir = parts.join(path.sep)
	    console.log(dir)
    } else {
    	//如果path 是一个文件
      dir = path.dirname(dest)
    }

    pathExists(dir, (err, dirExists) => {
      if (err) return callback(err)
      if (dirExists) return ncp(src, dest, options, callback)
      mkdir.mkdirs(dir, err => {
        if (err) return callback(err)
        ncp(src, dest, options, callback)
      })
    })
  })
}

module.exports = copy
